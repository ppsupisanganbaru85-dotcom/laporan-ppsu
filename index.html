<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Kerja PPSU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - Siap pakai untuk testing
        const firebaseConfig = {
  apiKey: "AIzaSyDEYy7CbLfw43BASudSgml3O6mNMImipFE",
  authDomain: "laporan-ppsu-b44e2.firebaseapp.com",
  projectId: "laporan-ppsu-b44e2",
  storageBucket: "laporan-ppsu-b44e2.firebasestorage.app",
  messagingSenderId: "165268646775",
  appId: "1:165268646775:web:aa8805e98695eca00a4f72",
  measurementId: "G-Q60BS2FJGE"
};
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.orderBy = orderBy;
        window.query = query;
    </script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-clipboard-list text-blue-600 text-2xl mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">Laporan PPSU</h1>
                        <p class="text-xs text-gray-500">pisangan baru</p>
                    </div>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <div class="text-right">
                        <div id="currentTime" class="text-sm font-medium text-gray-800"></div>
                        <div id="currentDate" class="text-xs text-gray-500"></div>
                    </div>
                    <button onclick="showPage('dashboard')" id="dashboardBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>Dashboard
                    </button>
                    <button onclick="checkAdminAccess()" id="adminBtn" class="px-4 py-2 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </button>
                </div>

                <!-- Mobile Navigation -->
                <div class="md:hidden flex items-center space-x-3">
                    <div class="text-right text-xs">
                        <div id="currentTimeMobile" class="font-semibold text-gray-800"></div>
                        <div id="currentDateMobile" class="text-gray-500"></div>
                    </div>
                    <button onclick="toggleMobileMenu()" id="hamburgerBtn" class="p-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-all duration-200">
                        <i id="hamburgerIcon" class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="md:hidden hidden bg-white border-t border-gray-200 shadow-lg slide-in">
            <div class="px-4 py-4 space-y-3">
                <button onclick="showPage('dashboard'); toggleMobileMenu();" id="dashboardBtnMobile" class="w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-all duration-200 shadow-sm">
                    <i class="fas fa-chart-bar mr-3 w-5"></i>Dashboard
                </button>
                <button onclick="checkAdminAccess(); toggleMobileMenu();" id="adminBtnMobile" class="w-full text-left px-4 py-3 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition-all duration-200 shadow-sm">
                    <i class="fas fa-cog mr-3 w-5"></i>Admin Panel
                </button>
                <div class="pt-2 border-t border-gray-200">
                    <div class="text-center text-xs text-gray-500">
                        <i class="fas fa-mobile-alt mr-1"></i>Mode Mobile
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Add Report Form -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-plus mr-2 text-blue-600"></i>Tambah Laporan Kerja
                </h2>
                <form id="workReportForm" class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tim</label>
                            <input type="text" id="tim" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Petugas Aktif</label>
                            <select id="petugasAktif" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Petugas</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Petugas Tidak Aktif</label>
                        <input type="text" id="petugasTidakAktif" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Kosongkan jika semua aktif">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Pekerjaan/Pengerjaan</label>
                        <textarea id="deskripsiPekerjaan" required rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Jelaskan detail pekerjaan yang dilakukan..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto Kerja</label>
                        <div class="space-y-4">
                            <!-- Camera Controls -->
                            <div class="flex flex-wrap gap-3">
                                <button type="button" onclick="openCamera('user')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-camera mr-2"></i>Kamera Depan
                                </button>
                                <button type="button" onclick="openCamera('environment')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-camera-retro mr-2"></i>Kamera Belakang
                                </button>
                                <button type="button" onclick="uploadPhoto()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-upload mr-2"></i>Upload File
                                </button>
                            </div>
                            
                            <!-- Hidden file input -->
                            <input type="file" id="photoUpload" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                            
                            <!-- Photo Preview -->
                            <div id="photoPreview" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Preview Foto:</label>
                                <div class="relative">
                                    <img id="previewImage" class="w-full max-w-md h-48 object-cover rounded-lg border">
                                    <button type="button" onclick="removePhoto()" class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden input to store photo data -->
                        <input type="hidden" id="fotoKerja" value="">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Area Kerja</label>
                        <input type="text" id="lokasiArea" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contoh: Jl. Pisangan Baru">
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Kerja</label>
                            <input type="text" id="jamKerja" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="07.20 - 15.20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Istirahat</label>
                            <input type="text" id="istirahat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="12.00 - 13.00">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Target</label>
                        <input type="text" id="catatanTarget" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Target pekerjaan hari ini...">
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                            <i class="fas fa-save mr-2"></i>Simpan Laporan
                        </button>
                        <button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                            <i class="fas fa-refresh mr-2"></i>Reset Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Header Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Laporan Aktif</p>
                            <p class="text-2xl font-bold text-gray-900" id="activeReports">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 text-red-600">
                            <i class="fas fa-exclamation-triangle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Belum Lapor</p>
                            <p class="text-2xl font-bold text-gray-900" id="pendingReports">43</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Petugas</p>
                            <p class="text-2xl font-bold text-gray-900">43</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-percentage text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Tingkat Kepatuhan</p>
                            <p class="text-2xl font-bold text-gray-900" id="complianceRate">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Controls -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-download mr-2 text-blue-600"></i>Export Data
                    </h2>
                    <div class="flex gap-3">
                        <button onclick="exportToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="exportToCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-file-csv mr-2"></i>Export CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Camera Modal -->
            <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-2xl w-full">
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-camera mr-2 text-blue-600"></i>Ambil Foto
                            </h4>
                            <button onclick="closeCamera()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="relative">
                            <video id="cameraVideo" class="w-full rounded-lg" autoplay playsinline></video>
                            <canvas id="photoCanvas" class="hidden"></canvas>
                        </div>
                        
                        <div class="flex justify-center gap-4 mt-4">
                            <button onclick="capturePhoto()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <i class="fas fa-camera mr-2"></i>Ambil Foto
                            </button>
                            <button onclick="switchCamera()" id="switchBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Ganti Kamera
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-table mr-2 text-blue-600"></i>Data Laporan Kerja Hari Ini
                        </h2>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-sync-alt mr-1"></i>Update Realtime
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-blue-50 to-indigo-50">
                            <tr>
                                <th class="px-3 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-users mr-1 text-blue-600"></i>Tim
                                </th>
                                <th class="px-3 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-user mr-1 text-green-600"></i>Nama Petugas
                                </th>
                                <th class="px-3 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider hidden sm:table-cell">
                                    <i class="fas fa-tools mr-1 text-orange-600"></i>Pengerjaan
                                </th>
                                <th class="px-3 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider hidden md:table-cell">
                                    <i class="fas fa-camera mr-1 text-pink-600"></i>Foto Kerja
                                </th>
                                <th class="px-3 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-map-marker-alt mr-1 text-purple-600"></i>Lokasi Area Kerja
                                </th>
                                <th class="px-3 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-cogs mr-1 text-gray-600"></i>Aksi
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noReportsMessage" class="text-center py-12 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p class="text-lg">Belum ada laporan hari ini</p>
                    <p class="text-sm">Laporan yang dibuat akan muncul di sini secara realtime</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="page hidden">
        <div class="min-h-screen flex items-center justify-center">
            <div class="max-w-md w-full mx-4">
                <div class="bg-white rounded-xl shadow-2xl p-8">
                    <div class="text-center mb-8">
                        <div class="mx-auto h-16 w-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-lock text-red-600 text-2xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Login Admin</h2>
                        <p class="text-gray-600 mt-2">Masukkan kredensial untuk mengakses panel admin</p>
                    </div>
                    
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Username atau password salah!
                        </div>
                        
                        <button type="submit" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                            <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                        </button>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button onclick="showPage('dashboard')" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-arrow-left mr-1"></i>Kembali ke Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Admin Header -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-user-shield mr-2 text-red-600"></i>Panel Admin
                    </h2>
                    <button onclick="logout()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
                <p class="text-gray-600 mt-2">Kelola dan pantau laporan kerja petugas PPSU</p>
            </div>

            <!-- Admin Export & Management Controls -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-download mr-2 text-green-600"></i>Export & Kelola Data
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">Export data laporan atau kelola penyimpanan Firebase</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="exportAdminToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="exportAdminToCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-file-csv mr-2"></i>Export CSV
                        </button>
                        <button onclick="checkStorageUsage()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                            <i class="fas fa-database mr-2"></i>Cek Storage
                        </button>
                        <button onclick="confirmDeleteAllData()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash-alt mr-2"></i>Hapus Semua
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Reports Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-table mr-2 text-blue-600"></i>Kelola Data Laporan
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-red-50 to-pink-50">
                            <tr>
                                <th class="px-3 sm:px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-users mr-1 text-blue-600"></i>Tim
                                </th>
                                <th class="px-3 sm:px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-user mr-1 text-green-600"></i>Nama Petugas
                                </th>
                                <th class="px-3 sm:px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider hidden sm:table-cell">
                                    <i class="fas fa-tools mr-1 text-orange-600"></i>Pengerjaan
                                </th>
                                <th class="px-3 sm:px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider hidden md:table-cell">
                                    <i class="fas fa-camera mr-1 text-pink-600"></i>Foto Kerja
                                </th>
                                <th class="px-3 sm:px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-map-marker-alt mr-1 text-purple-600"></i>Lokasi Area Kerja
                                </th>
                                <th class="px-3 sm:px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-tools mr-1 text-red-600"></i>Aksi
                                </th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Firebase Management Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-database mr-2 text-orange-600"></i>Manajemen Firebase
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-blue-800">Status Koneksi</h4>
                            <div id="firebaseStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-200 text-gray-600">
                                Checking...
                            </div>
                        </div>
                        <p class="text-sm text-blue-600">Memantau koneksi ke Firebase Firestore</p>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-green-800">Total Data</h4>
                            <span id="totalFirebaseData" class="text-2xl font-bold text-green-600">0</span>
                        </div>
                        <p class="text-sm text-green-600">Jumlah laporan di Firebase</p>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-purple-800">Sinkronisasi</h4>
                            <button onclick="syncFirebaseData()" class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>Sync
                            </button>
                        </div>
                        <p class="text-sm text-purple-600">Sinkronkan data manual</p>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Informasi Firebase
                    </h4>
                    <div class="text-sm text-yellow-700 space-y-1">
                        <p><strong>Project ID:</strong> <span id="firebaseProjectId">laporan-ppsu-demo</span></p>
                        <p><strong>Collection:</strong> workReports</p>
                        <p><strong>Mode:</strong> <span id="firebaseMode">Real-time Listener</span></p>
                    </div>
                </div>
            </div>

            <!-- Monitoring Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-eye mr-2 text-purple-600"></i>Pemantauan Petugas
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3 text-green-600">
                            <i class="fas fa-check-circle mr-2"></i>Sudah Melaporkan
                        </h4>
                        <div id="reportedOfficers" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Will be populated -->
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3 text-red-600">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Belum Melaporkan
                        </h4>
                        <div id="unreportedOfficers" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>Detail Laporan
                    </h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="modalContent">
                    <!-- Content will be populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4">
        <div class="relative max-w-4xl w-full">
            <button onclick="closePhotoModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <img id="photoModalImage" class="w-full h-auto max-h-[90vh] object-contain rounded-lg">
        </div>
    </div>

    <script>
        // Data petugas
        const officers = [
            "Achmad Rosidi", "Ade Kurniawan", "Al Azahar", "Alwi", "Arif Abdul Rahman",
            "Asep", "Chandra Darmawan", "Daday Sukandar", "Dea Sabilah Handriyani",
            "Deni Arcis", "Dewo Panca Pamungkas", "Dimas Herwinto Pradana", "Eris Sumiadi",
            "Fida Marzuki Putra", "Herdinsah", "Hermansyah", "Hikmatun Nisa", "Ihsan Muttaqien",
            "Ilham Prayitno Yudo", "Indra Jaya", "Irfan Mahadi", "M. Yusuf", "Maryanto",
            "Mohamad Irwan Yulianto", "Muhammad Khomeini", "Nur Iman", "Nuryana", "Puji Lestari",
            "Pujiyanto", "Rafly Nugraha", "Rahman", "Rahmat Agustio", "Reynaldi Saputra",
            "Rizky Prasetia", "Rohmah", "Sabar Minggudi", "Siti Marsah", "Suhanda",
            "Supardi", "Suwandi", "Syaiful Huda", "Tri Julianto", "Wiyono Fauzy"
        ];

        // Firebase data storage
        let workReports = [];
        let editingId = null;
        let isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
        let unsubscribe = null;
        
        // Camera variables
        let currentStream = null;
        let currentFacingMode = 'environment';
        let photoData = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            populateOfficerSelect();
            updateRealTime();
            setupFirebaseListener();
            updateFirebaseStatus();
            
            // Update time every second
            setInterval(updateRealTime, 1000);
            
            // Update Firebase status every 30 seconds
            setInterval(updateFirebaseStatus, 30000);
            
            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (username === 'elfida' && password === 'pis212oK') {
                    isLoggedIn = true;
                    sessionStorage.setItem('adminLoggedIn', 'true');
                    showPage('admin');
                    document.getElementById('loginError').classList.add('hidden');
                    document.getElementById('loginForm').reset();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                    document.getElementById('password').value = '';
                }
            });
        });

        // Update Firebase status
        function updateFirebaseStatus() {
            const statusEl = document.getElementById('firebaseStatus');
            const totalDataEl = document.getElementById('totalFirebaseData');
            const modeEl = document.getElementById('firebaseMode');
            
            if (typeof window.db !== 'undefined') {
                statusEl.className = 'px-2 py-1 rounded text-xs font-medium bg-green-200 text-green-800';
                statusEl.textContent = 'Connected';
                modeEl.textContent = 'Real-time Listener';
            } else {
                statusEl.className = 'px-2 py-1 rounded text-xs font-medium bg-red-200 text-red-800';
                statusEl.textContent = 'Offline';
                modeEl.textContent = 'Local Storage';
            }
            
            if (totalDataEl) {
                totalDataEl.textContent = workReports.length;
            }
        }

        // Sync Firebase data manually
        async function syncFirebaseData() {
            if (typeof window.db === 'undefined') {
                alert('Firebase tidak tersedia. Menggunakan localStorage.');
                return;
            }
            
            try {
                const q = query(collection(db, 'workReports'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                workReports = [];
                querySnapshot.forEach((doc) => {
                    workReports.push({ id: doc.id, ...doc.data() });
                });
                
                updateDashboard();
                updateAdminTable();
                updateMonitoring();
                updateDashboardTable();
                updateFirebaseStatus();
                
                alert(`Sinkronisasi berhasil! ${workReports.length} data dimuat dari Firebase.`);
            } catch (error) {
                console.error('Sync error:', error);
                alert('Gagal sinkronisasi: ' + error.message);
            }
        }

        // Update real-time clock
        function updateRealTime() {
            const now = new Date();
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            };
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            const timeString = now.toLocaleTimeString('id-ID', timeOptions);
            const dateString = now.toLocaleDateString('id-ID', dateOptions);
            
            // Update desktop time
            const timeEl = document.getElementById('currentTime');
            const dateEl = document.getElementById('currentDate');
            if (timeEl) timeEl.textContent = timeString;
            if (dateEl) dateEl.textContent = dateString;
            
            // Update mobile time
            const timeMobileEl = document.getElementById('currentTimeMobile');
            const dateMobileEl = document.getElementById('currentDateMobile');
            if (timeMobileEl) timeMobileEl.textContent = timeString;
            if (dateMobileEl) dateMobileEl.textContent = dateString;
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerIcon = document.getElementById('hamburgerIcon');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                hamburgerIcon.className = 'fas fa-times text-xl';
            } else {
                mobileMenu.classList.add('hidden');
                hamburgerIcon.className = 'fas fa-bars text-xl';
            }
        }

        // Setup Firebase real-time listener
        function setupFirebaseListener() {
            if (typeof window.db === 'undefined') {
                console.log('Firebase not initialized, using localStorage');
                workReports = JSON.parse(localStorage.getItem('workReports')) || [];
                updateDashboard();
                updateAdminTable();
                updateMonitoring();
                updateDashboardTable();
                return;
            }

            try {
                const q = query(collection(db, 'workReports'), orderBy('timestamp', 'desc'));
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    workReports = [];
                    querySnapshot.forEach((doc) => {
                        workReports.push({ id: doc.id, ...doc.data() });
                    });
                    updateDashboard();
                    updateAdminTable();
                    updateMonitoring();
                    updateDashboardTable();
                });
            } catch (error) {
                console.error('Firebase listener error:', error);
                // Fallback to localStorage
                workReports = JSON.parse(localStorage.getItem('workReports')) || [];
                updateDashboard();
                updateAdminTable();
                updateMonitoring();
                updateDashboardTable();
            }
        }

        // Populate officer select
        function populateOfficerSelect() {
            const select = document.getElementById('petugasAktif');
            officers.forEach(officer => {
                const option = document.createElement('option');
                option.value = officer;
                option.textContent = officer;
                select.appendChild(option);
            });
        }

        // Check admin access
        function checkAdminAccess() {
            if (isLoggedIn) {
                showPage('admin');
            } else {
                showPage('login');
            }
        }

        // Logout function
        function logout() {
            isLoggedIn = false;
            sessionStorage.removeItem('adminLoggedIn');
            showPage('dashboard');
            alert('Anda telah logout dari panel admin');
        }

        // Page navigation
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            // Update desktop button states
            const dashboardBtn = document.getElementById('dashboardBtn');
            const adminBtn = document.getElementById('adminBtn');
            
            if (dashboardBtn) {
                dashboardBtn.className = page === 'dashboard' 
                    ? 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                    : 'px-4 py-2 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition-colors';
            }
            
            if (adminBtn) {
                adminBtn.className = (page === 'admin' || page === 'login')
                    ? 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                    : 'px-4 py-2 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition-colors';
            }
            
            // Update mobile button states
            const dashboardBtnMobile = document.getElementById('dashboardBtnMobile');
            const adminBtnMobile = document.getElementById('adminBtnMobile');
            
            if (dashboardBtnMobile) {
                dashboardBtnMobile.className = page === 'dashboard' 
                    ? 'w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                    : 'w-full text-left px-4 py-3 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition-colors';
            }
            
            if (adminBtnMobile) {
                adminBtnMobile.className = (page === 'admin' || page === 'login')
                    ? 'w-full text-left px-4 py-3 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors'
                    : 'w-full text-left px-4 py-3 rounded-lg bg-gray-600 text-white font-medium hover:bg-gray-700 transition-colors';
            }
            
            // Update Firebase status when switching to admin page
            if (page === 'admin') {
                updateFirebaseStatus();
            }
        }

        // Form handling
        function resetForm() {
            document.getElementById('workReportForm').reset();
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('fotoKerja').value = '';
            document.getElementById('photoUpload').value = '';
        }

        // Form submission
        document.getElementById('workReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                tim: document.getElementById('tim').value,
                petugasAktif: document.getElementById('petugasAktif').value,
                petugasTidakAktif: document.getElementById('petugasTidakAktif').value,
                deskripsiPekerjaan: document.getElementById('deskripsiPekerjaan').value,
                fotoKerja: document.getElementById('fotoKerja').value,
                lokasiArea: document.getElementById('lokasiArea').value,
                jamKerja: document.getElementById('jamKerja').value,
                istirahat: document.getElementById('istirahat').value,
                catatanTarget: document.getElementById('catatanTarget').value,
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktuLapor: new Date().toLocaleTimeString('id-ID'),
                timestamp: new Date(),
                status: 'Aktif'
            };

            try {
                if (typeof window.db !== 'undefined') {
                    // Save to Firebase
                    await addDoc(collection(db, 'workReports'), formData);
                    alert('Laporan berhasil disimpan ke Firebase!');
                } else {
                    // Fallback to localStorage
                    formData.id = Date.now().toString();
                    workReports.push(formData);
                    localStorage.setItem('workReports', JSON.stringify(workReports));
                    updateDashboard();
                    updateAdminTable();
                    updateMonitoring();
                    updateDashboardTable();
                    alert('Laporan berhasil disimpan (localStorage)!');
                }
                
                resetForm();
                
            } catch (error) {
                console.error('Error saving report:', error);
                alert('Gagal menyimpan laporan: ' + error.message);
            }
        });

        // Update dashboard
        function updateDashboard() {
            const activeReports = workReports.length;
            const totalOfficers = officers.length;
            const pendingReports = totalOfficers - activeReports;
            const complianceRate = totalOfficers > 0 ? Math.round((activeReports / totalOfficers) * 100) : 0;

            document.getElementById('activeReports').textContent = activeReports;
            document.getElementById('pendingReports').textContent = pendingReports;
            document.getElementById('complianceRate').textContent = complianceRate + '%';
        }

        // Update dashboard table with new format
        function updateDashboardTable() {
            const tbody = document.getElementById('dashboardTableBody');
            const noReportsMessage = document.getElementById('noReportsMessage');
            
            if (workReports.length === 0) {
                tbody.innerHTML = '';
                noReportsMessage.style.display = 'block';
                return;
            }
            
            noReportsMessage.style.display = 'none';
            tbody.innerHTML = '';

            workReports.forEach((report, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 fade-in transition-all duration-200';
                row.innerHTML = `
                    <td class="px-3 py-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-xs font-bold text-blue-600">${index + 1}</span>
                            </div>
                            <span class="font-semibold text-gray-900">${report.tim}</span>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-blue-700 font-medium">${report.petugasAktif}</span>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm hidden sm:table-cell">
                        <div class="text-gray-700">
                            <span class="truncate max-w-48 block">${report.deskripsiPekerjaan}</span>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm text-gray-500 hidden md:table-cell">
                        ${report.fotoKerja ? 
                            `<img src="${report.fotoKerja}" alt="Foto" class="w-14 h-14 object-cover rounded-lg cursor-pointer hover:scale-105 transition-transform shadow-sm border-2 border-gray-200" onclick="viewPhoto('${report.fotoKerja}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                             <div class="w-14 h-14 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400" style="display: none;"><i class="fas fa-image-slash"></i></div>` 
                            : '<div class="w-14 h-14 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400"><i class="fas fa-camera-slash"></i></div>'
                        }
                    </td>
                    <td class="px-3 py-4 text-sm">
                        <div class="flex items-center text-purple-700">
                            <i class="fas fa-map-pin text-xs mr-2"></i>
                            <span class="truncate max-w-32">${report.lokasiArea}</span>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm font-medium">
                        <button onclick="viewDetail('${report.id}')" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                            <i class="fas fa-eye mr-1"></i>Detail
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update admin table with new format
        function updateAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';

            workReports.forEach((report, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-red-50 transition-all duration-200';
                row.innerHTML = `
                    <td class="px-3 sm:px-6 py-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-xs font-bold text-red-600">${index + 1}</span>
                            </div>
                            <span class="font-semibold text-gray-900">${report.tim}</span>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-4 text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-green-700 font-medium">${report.petugasAktif}</span>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-4 text-sm hidden sm:table-cell">
                        <div class="text-gray-700">
                            <span class="truncate max-w-40 block">${report.deskripsiPekerjaan}</span>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-4 text-sm text-gray-500 hidden md:table-cell">
                        ${report.fotoKerja ? 
                            `<img src="${report.fotoKerja}" alt="Foto" class="w-16 h-16 object-cover rounded-lg cursor-pointer hover:scale-105 transition-transform shadow-md border-2 border-pink-200" onclick="viewPhoto('${report.fotoKerja}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                             <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400" style="display: none;"><i class="fas fa-image-slash"></i></div>` 
                            : '<div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400"><i class="fas fa-camera-slash"></i></div>'
                        }
                    </td>
                    <td class="px-3 sm:px-6 py-4 text-sm">
                        <div class="flex items-center text-purple-700">
                            <i class="fas fa-map-pin text-xs mr-2"></i>
                            <span class="truncate max-w-40">${report.lokasiArea}</span>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-4 text-sm font-medium">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button onclick="viewDetail('${report.id}')" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                                <i class="fas fa-eye mr-1"></i>Detail
                            </button>
                            <button onclick="deleteReport('${report.id}')" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 hover:bg-red-200 transition-colors">
                                <i class="fas fa-trash mr-1"></i>Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update monitoring
        function updateMonitoring() {
            const reportedOfficers = workReports.map(r => r.petugasAktif);
            const unreportedOfficers = officers.filter(o => !reportedOfficers.includes(o));

            const reportedDiv = document.getElementById('reportedOfficers');
            const unreportedDiv = document.getElementById('unreportedOfficers');

            reportedDiv.innerHTML = reportedOfficers.map(officer => 
                `<div class="flex items-center p-2 bg-green-50 rounded-lg">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    <span class="text-sm text-gray-700">${officer}</span>
                </div>`
            ).join('');

            unreportedDiv.innerHTML = unreportedOfficers.map(officer => 
                `<div class="flex items-center p-2 bg-red-50 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                    <span class="text-sm text-gray-700">${officer}</span>
                </div>`
            ).join('');
        }

        // Export functions
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(workReports);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan PPSU");
            XLSX.writeFile(wb, `laporan_ppsu_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToCSV() {
            const headers = ['Tim', 'Petugas Aktif', 'Petugas Tidak Aktif', 'Deskripsi Pekerjaan', 'Lokasi Area', 'Jam Kerja', 'Istirahat', 'Catatan Target', 'Tanggal', 'Status'];
            const csvContent = [
                headers.join(','),
                ...workReports.map(report => [
                    report.tim,
                    report.petugasAktif,
                    report.petugasTidakAktif || '',
                    `"${report.deskripsiPekerjaan}"`,
                    report.lokasiArea,
                    report.jamKerja,
                    report.istirahat || '',
                    report.catatanTarget || '',
                    report.tanggal,
                    report.status
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `laporan_ppsu_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Admin Export Functions
        function exportAdminToExcel() {
            if (workReports.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            const exportData = workReports.map((report, index) => ({
                'No': index + 1,
                'Tim': report.tim,
                'Nama Petugas': report.petugasAktif,
                'Petugas Tidak Aktif': report.petugasTidakAktif || '-',
                'Pengerjaan': report.deskripsiPekerjaan,
                'Lokasi Area Kerja': report.lokasiArea,
                'Jam Kerja': report.jamKerja,
                'Istirahat': report.istirahat || '-',
                'Catatan Target': report.catatanTarget || '-',
                'Tanggal': report.tanggal,
                'Waktu Lapor': report.waktuLapor,
                'Status': report.status || 'Aktif'
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Laporan PPSU");
            XLSX.writeFile(wb, `admin_laporan_ppsu_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert(`Data berhasil diekspor! ${workReports.length} laporan telah disimpan ke Excel.`);
        }

        function exportAdminToCSV() {
            if (workReports.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            const headers = ['No', 'Tim', 'Nama Petugas', 'Petugas Tidak Aktif', 'Pengerjaan', 'Lokasi Area Kerja', 'Jam Kerja', 'Istirahat', 'Catatan Target', 'Tanggal', 'Waktu Lapor', 'Status'];
            const csvContent = [
                headers.join(','),
                ...workReports.map((report, index) => [
                    index + 1,
                    `"${report.tim}"`,
                    `"${report.petugasAktif}"`,
                    `"${report.petugasTidakAktif || '-'}"`,
                    `"${report.deskripsiPekerjaan}"`,
                    `"${report.lokasiArea}"`,
                    `"${report.jamKerja}"`,
                    `"${report.istirahat || '-'}"`,
                    `"${report.catatanTarget || '-'}"`,
                    `"${report.tanggal}"`,
                    `"${report.waktuLapor}"`,
                    `"${report.status || 'Aktif'}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `admin_laporan_ppsu_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert(`Data berhasil diekspor! ${workReports.length} laporan telah disimpan ke CSV.`);
        }

        // Storage Management Functions
        function checkStorageUsage() {
            const dataSize = JSON.stringify(workReports).length;
            const dataSizeKB = (dataSize / 1024).toFixed(2);
            const dataSizeMB = (dataSize / (1024 * 1024)).toFixed(2);
            
            let storageInfo = ` INFORMASI PENYIMPANAN\n\n`;
            storageInfo += ` Total Data: ${workReports.length} laporan\n`;
            storageInfo += ` Ukuran Data: ${dataSizeKB} KB (${dataSizeMB} MB)\n\n`;
            
            if (typeof window.db !== 'undefined') {
                storageInfo += ` Firebase Status: Terhubung\n`;
                storageInfo += ` Mode: Real-time Sync\n\n`;
                
                if (dataSizeMB > 50) {
                    storageInfo += ` PERINGATAN: Data sudah cukup besar!\n`;
                    storageInfo += ` Pertimbangkan untuk menghapus data lama.`;
                } else if (dataSizeMB > 20) {
                    storageInfo += ` INFO: Ukuran data sedang.\n`;
                    storageInfo += ` Pantau terus penggunaan storage.`;
                } else {
                    storageInfo += ` BAIK: Ukuran data masih optimal.`;
                }
            } else {
                storageInfo += ` Local Storage: Aktif\n`;
                storageInfo += ` Mode: Offline Storage\n\n`;
                storageInfo += ` Data disimpan di browser lokal.`;
            }
            
            alert(storageInfo);
        }

        function confirmDeleteAllData() {
            const confirmMessage = ` PERINGATAN PENTING!\n\n` +
                `Anda akan menghapus SEMUA data laporan (${workReports.length} laporan).\n\n` +
                ` Tindakan ini TIDAK DAPAT DIBATALKAN!\n\n` +
                `Pastikan Anda sudah mengekspor data penting sebelum melanjutkan.\n\n` +
                `Ketik "HAPUS SEMUA" untuk konfirmasi:`;
                
            const userInput = prompt(confirmMessage);
            
            if (userInput === "HAPUS SEMUA") {
                deleteAllData();
            } else if (userInput !== null) {
                alert(' Konfirmasi tidak sesuai. Data tidak dihapus.');
            }
        }

        async function deleteAllData() {
            try {
                if (typeof window.db !== 'undefined') {
                    // Delete all from Firebase
                    const deletePromises = workReports.map(report => 
                        deleteDoc(doc(db, 'workReports', report.id))
                    );
                    
                    await Promise.all(deletePromises);
                    alert(` Berhasil menghapus ${workReports.length} laporan dari Firebase!`);
                } else {
                    // Clear localStorage
                    const deletedCount = workReports.length;
                    workReports = [];
                    localStorage.setItem('workReports', JSON.stringify(workReports));
                    
                    updateDashboard();
                    updateAdminTable();
                    updateMonitoring();
                    updateDashboardTable();
                    updateFirebaseStatus();
                    
                    alert(` Berhasil menghapus ${deletedCount} laporan dari localStorage!`);
                }
            } catch (error) {
                console.error('Error deleting all data:', error);
                alert(' Gagal menghapus data: ' + error.message);
            }
        }

        // Delete report
        async function deleteReport(id) {
            if (confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
                try {
                    if (typeof window.db !== 'undefined') {
                        // Delete from Firebase
                        await deleteDoc(doc(db, 'workReports', id));
                        alert('Laporan berhasil dihapus dari Firebase!');
                    } else {
                        // Delete from localStorage
                        workReports = workReports.filter(r => r.id !== id);
                        localStorage.setItem('workReports', JSON.stringify(workReports));
                        updateDashboard();
                        updateAdminTable();
                        updateMonitoring();
                        updateDashboardTable();
                        alert('Laporan berhasil dihapus!');
                    }
                } catch (error) {
                    console.error('Error deleting report:', error);
                    alert('Gagal menghapus laporan: ' + error.message);
                }
            }
        }

        // View detail
        function viewDetail(id) {
            const report = workReports.find(r => r.id === id);
            if (!report) return;

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tim</label>
                            <p class="mt-1 text-sm text-gray-900">${report.tim}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Petugas Aktif</label>
                            <p class="mt-1 text-sm text-gray-900">${report.petugasAktif}</p>
                        </div>
                    </div>
                    
                    ${report.petugasTidakAktif ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Petugas Tidak Aktif</label>
                        <p class="mt-1 text-sm text-gray-900">${report.petugasTidakAktif}</p>
                    </div>
                    ` : ''}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Deskripsi Pekerjaan</label>
                        <p class="mt-1 text-sm text-gray-900">${report.deskripsiPekerjaan}</p>
                    </div>
                    
                    ${report.fotoKerja ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Foto Kerja</label>
                        <img src="${report.fotoKerja}" alt="Foto Kerja" class="mt-2 max-w-full h-48 object-cover rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="mt-2 p-4 bg-gray-100 rounded-lg text-center text-gray-500" style="display: none;">
                            <i class="fas fa-image text-2xl mb-2"></i>
                            <p>Foto tidak dapat dimuat</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Lokasi Area Kerja</label>
                            <p class="mt-1 text-sm text-gray-900">${report.lokasiArea}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Jam Kerja</label>
                            <p class="mt-1 text-sm text-gray-900">${report.jamKerja}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Istirahat</label>
                            <p class="mt-1 text-sm text-gray-900">${report.istirahat || '-'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Catatan Target</label>
                            <p class="mt-1 text-sm text-gray-900">${report.catatanTarget || '-'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tanggal Laporan</label>
                        <p class="mt-1 text-sm text-gray-900">${report.tanggal}</p>
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // Photo viewer functions
        function viewPhoto(photoSrc) {
            document.getElementById('photoModalImage').src = photoSrc;
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        // Google Sheets integration (placeholder function)
        function sendToGoogleSheets(data) {
            // This is a placeholder function
            // In real implementation, you would use Google Apps Script Web App URL
            console.log('Data to be sent to Google Sheets:', data);
            
            // Example implementation would be:
            // fetch('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(data)
            // });
        }

        // Camera Functions
        async function openCamera(facingMode = 'environment') {
            try {
                currentFacingMode = facingMode;
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraVideo');
                video.srcObject = currentStream;
                
                document.getElementById('cameraModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.');
            }
        }

        function closeCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
        }

        async function switchCamera() {
            closeCamera();
            const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await openCamera(newFacingMode);
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to base64
            const photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            // Store photo data
            document.getElementById('fotoKerja').value = photoDataUrl;
            document.getElementById('previewImage').src = photoDataUrl;
            document.getElementById('photoPreview').classList.remove('hidden');
            
            // Clear URL input if photo was taken
            document.getElementById('fotoKerjaURL').value = '';
            
            closeCamera();
            alert('Foto berhasil diambil!');
        }

        function uploadPhoto() {
            document.getElementById('photoUpload').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoDataUrl = e.target.result;
                    
                    // Store photo data
                    document.getElementById('fotoKerja').value = photoDataUrl;
                    document.getElementById('previewImage').src = photoDataUrl;
                    document.getElementById('photoPreview').classList.remove('hidden');
                    
                    // Clear URL input if file was uploaded
                    document.getElementById('fotoKerjaURL').value = '';
                    
                    alert('Foto berhasil diupload!');
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            document.getElementById('fotoKerja').value = '';
            document.getElementById('previewImage').src = '';
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoUpload').value = '';
        }

        // Close modal when clicking outside
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Close camera modal when clicking outside
        document.getElementById('cameraModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCamera();
            }
        });
        
        // Close photo modal when clicking outside
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoModal();
            }
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            
            if (!mobileMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                if (!mobileMenu.classList.contains('hidden')) {
                    toggleMobileMenu();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9726becc56bce782',t:'MTc1NTc0MzgxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
